import http from "node:http";  // it is good pratice to use node: this tells engine that it is a node module not out our js module thus saving time as node does not have to search out own created modules

export const destinations = [
  {
    name: "Waitomo Glowworm Caves",
    location: "Waitomo",
    country: "New Zealand",
    continent: "Oceania",
    is_open_to_public: true,
    details: [
      {
        fun_fact:
          "The glowworms create a star-like effect on the cave ceiling using bioluminescence.",
      },
      {
        description:
          "A subterranean network of limestone caverns famous for its magical boat rides under twinkling glowworm-lit ceilings.",
      },
    ],
    uuid: "550e8400-e29b-41d4-a716-446655440001"
  },
  {
    name: "The Door to Hell",
    location: "Darvaza",
    country: "Turkmenistan",
    continent: "Asia",
    is_open_to_public: true,
    details: [
      {
        fun_fact:
          "This fiery crater has been burning since 1971 after a drilling accident.",
      },
      {
        description:
          "A continuously burning gas crater in the Karakum Desert, captivating adventurous travelers with its otherworldly glow.",
      },
    ],
    uuid: "550e8400-e29b-41d4-a716-446655440002"
  },
  {
    name: "Underwater Waterfall",
    location: "Mauritius",
    country: "Mauritius",
    continent: "Africa",
    is_open_to_public: true,
    details: [
      {
        fun_fact:
          "This optical illusion is caused by sand and silt deposits under the water.",
      },
      {
        description:
          "An incredible illusion off the island’s coast, appearing as if water cascades into a vast underwater abyss.",
      },
    ],
    uuid: "550e8400-e29b-41d4-a716-446655440003"
  },
  {
    name: "Giant's Causeway",
    location: "County Antrim",
    country: "Northern Ireland",
    continent: "Europe",
    is_open_to_public: true,
    details: [
      {
        fun_fact:
          "The hexagonal columns are formed by ancient volcanic activity.",
      },
      {
        description:
          "A UNESCO World Heritage Site featuring striking hexagonal basalt columns along the scenic Northern Irish coastline.",
      },
    ],
    uuid: "550e8400-e29b-41d4-a716-446655440004"
  },
  {
    name: "Fly Geyser",
    location: "Nevada",
    country: "USA",
    continent: "North America",
    is_open_to_public: false,
    details: [
      {
        fun_fact:
          "The geyser was accidentally created by well drilling in 1964.",
      },
      {
        description:
          "A colorful, continuously spouting geothermal formation with vibrant mineral deposits on a private Nevada ranch.",
      },
    ],
    uuid: "550e8400-e29b-41d4-a716-446655440005"
  },
  {
    name: "Kjeragbolten",
    location: "Rogaland",
    country: "Norway",
    continent: "Europe",
    is_open_to_public: true,
    details: [
      {
        fun_fact:
          "A giant boulder wedged in a mountain crevice with a 984-meter drop beneath it.",
      },
      {
        description:
          "A legendary hiking destination where brave visitors can stand on a rock suspended between two cliffs.",
      },
    ],
    uuid: "550e8400-e29b-41d4-a716-446655440006"
  },
  {
    name: "The Wave",
    location: "Arizona",
    country: "USA",
    continent: "North America",
    is_open_to_public: true,
    details: [
      {
        fun_fact: "The sandstone formations look like waves frozen in time.",
      },
      {
        description:
          "A sought-after hiking spot in the Coyote Buttes area, prized for its surreal, undulating sandstone formations.",
      },
    ],
    uuid: "550e8400-e29b-41d4-a716-446655440007"
  },
  {
    name: "Socotra Island",
    location: "Socotra",
    country: "Yemen",
    continent: "Asia",
    is_open_to_public: true,
    details: [
      {
        fun_fact: "Home to alien-looking dragon blood trees.",
      },
      {
        description:
          "A remote and biologically diverse island, known for its unique flora and striking desert landscapes.",
      },
    ],
    uuid: "550e8400-e29b-41d4-a716-446655440008"
  },
  {
    name: "Pamukkale",
    location: "Denizli",
    country: "Turkey",
    continent: "Asia",
    is_open_to_public: true,
    details: [
      {
        fun_fact:
          "The white terraces are made of travertine, a mineral deposited by thermal springs.",
      },
      {
        description:
          "A famed natural site boasting tiered, cotton-white terraces and warm mineral-rich waters for bathing.",
      },
    ],
    uuid: "550e8400-e29b-41d4-a716-446655440009"
  },
  {
    name: "Cano Cristales",
    location: "Meta",
    country: "Colombia",
    continent: "South America",
    is_open_to_public: true,
    details: [
      {
        fun_fact:
          "Known as the 'Liquid Rainbow,' it glows in five colors during certain seasons.",
      },
      {
        description:
          "A mesmerizing river whose aquatic plants and algae create a kaleidoscope of vibrant hues.",
      },
    ],
    uuid: "550e8400-e29b-41d4-a716-446655440010",
  },
  {
    name: "Red Beach",
    location: "Panjin",
    country: "China",
    continent: "Asia",
    is_open_to_public: true,
    details: [
      {
        fun_fact:
          "The beach gets its vibrant red color from the plant Suaeda salsa.",
      },
      {
        description:
          "A striking coastal wetland carpeted by red seaweed, popular for its unique color and birdlife.",
      },
    ],
    uuid: "550e8400-e29b-41d4-a716-446655440011",
  },
  {
    name: "Devil's Pool",
    location: "Victoria Falls",
    country: "Zambia",
    continent: "Africa",
    is_open_to_public: true,
    details: [
      {
        fun_fact: "A natural infinity pool at the edge of a waterfall.",
      },
      {
        description:
          "A thrilling dip right on the brink of Victoria Falls, offering daredevils a breathtaking view of the drop.",
      },
    ],
    uuid: "550e8400-e29b-41d4-a716-446655440012",
  },
  {
    name: "Mendenhall Ice Caves",
    location: "Juneau",
    country: "USA",
    continent: "North America",
    is_open_to_public: false,
    details: [
      {
        fun_fact:
          "The caves are formed under a glacier, creating glowing blue tunnels.",
      },
      {
        description:
          "A hidden world of otherworldly, icy blue chambers inside the Mendenhall Glacier, accessible only by adventurous treks.",
      },
    ],
    uuid: "550e8400-e29b-41d4-a716-446655440013",
  },
  {
    name: "Moeraki Boulders",
    location: "Koekohe Beach",
    country: "New Zealand",
    continent: "Oceania",
    is_open_to_public: true,
    details: [
      {
        fun_fact:
          "These spherical boulders were formed from calcite over millions of years.",
      },
      {
        description:
          "Mysterious, perfectly round boulders scattered along a picturesque coastline, steeped in Māori legend.",
      },
    ],
    uuid: "550e8400-e29b-41d4-a716-446655440014",
  },
  {
    name: "Magnetic Hill",
    location: "Ladakh",
    country: "India",
    continent: "Asia",
    is_open_to_public: true,
    details: [
      {
        fun_fact: "Vehicles appear to roll uphill due to an optical illusion.",
      },
      {
        description:
          "A perplexing stretch of road in the Himalayas where gravity seemingly takes a puzzling turn.",
      },
    ],
    uuid: "550e8400-e29b-41d4-a716-446655440015",
  },
  {
    name: "Cueva de los Cristales",
    location: "Chihuahua",
    country: "Mexico",
    continent: "North America",
    is_open_to_public: false,
    details: [
      {
        fun_fact: "Home to giant gypsum crystals, some over 10 meters long.",
      },
      {
        description:
          "An astonishing cavern filled with massive, glimmering selenite crystals hidden deep beneath the Earth’s surface.",
      },
    ],
    uuid: "550e8400-e29b-41d4-a716-446655440016",
  },
  {
    name: "Snake Island",
    location: "Ilha da Queimada Grande",
    country: "Brazil",
    continent: "South America",
    is_open_to_public: false,
    details: [
      {
        fun_fact:
          "Home to one of the most venomous snakes in the world, the golden lancehead.",
      },
      {
        description:
          "A secluded and highly restricted island swarming with venomous snakes, enforcing a strict no-visitor policy.",
      },
    ],
    uuid: "550e8400-e29b-41d4-a716-446655440017",
  },
  {
    name: "North Sentinel Island",
    location: "Andaman Islands",
    country: "India",
    continent: "Asia",
    is_open_to_public: false,
    details: [
      {
        fun_fact:
          "Inhabited by an uncontacted tribe, it is completely off-limits to visitors.",
      },
      {
        description:
          "A remote island in the Bay of Bengal, home to an isolated tribe who protect their way of life fiercely.",
      },
    ],
    uuid: "550e8400-e29b-41d4-a716-446655440018",
  },
  {
    name: "Mount Mihara Volcano Jail",
    location: "Izu Oshima Island",
    country: "Japan",
    continent: "Asia",
    is_open_to_public: false,
    details: [
      {
        fun_fact:
          "A former volcanic prison, it is no longer operational but remains restricted.",
      },
      {
        description:
          "A historical penal facility once perched on an active volcano, now off-limits and shrouded in intrigue.",
      },
    ],
    uuid: "550e8400-e29b-41d4-a716-446655440019",
  }
];

function getFilteredData(locType, locName) {
  return destinations.filter(destination => destination[locType].toLowerCase() === locName.toLowerCase());
}

function sendResponse(res, status, data){

  // by default browsers block any request not coming from the same port and domain as backend, but we want to allow request from any doamin and any port so we use CORS for that here we can set which ports we are allowing the request to come from

  res.setHeader('Access-Control-Allow-Origin', '*'); // here * means we are allowing request to come form any doamin and port
  res.setHeader('Access-Control-Allow-Methods', 'GET');  // here we only allow GET method
  res.statusCode = status;
  res.setHeader('Content-Type', 'application/json');
  res.end(JSON.stringify(data));
}

// // PATH Parameters
// const server = http.createServer((req, res) => {
//     // res.end("Hello from server");
//     // res.end() takes 3 parameters
//     // 1- "Message" or data 2- encoding type-> default is 'utf8' and a call backfunction that runs at the end

//     if (req.url === '/api' && req.method === 'GET') {
//         res.end("Request is on api route and GET Method");
//         return;
//     }

//     if (req.url.startsWith('/api/continent/') && req.method === 'GET') {
//       const continent = req.url.split('/').pop();

//       if(!continent) {
//         sendResponse(res, 400, {error: "Continent not found"});
//         return;
//       }

//       const filteredData = getFilteredData('continent', continent);

//       sendResponse(res, 200, filteredData);
//       return;
//     }

//     if (req.url === '/destinations' && req.method === 'GET') {
//         sendResponse(res, 200, destinations);
//         return;
//     }

//     res.write("This is some data. ");  // write to response body but not end
//     res.write("This is some more data\n");  // write to response body but not end
//     res.end("This is the ending message", 'utf8', () => console.log("Response ended"));  // write to response body and end the response stream

//     // res.end();   // this can also be used
// })

// server.listen(8000, () => console.log("Server running on port 8000"));

const getDatabyQueryParams = (data, queryObj) => {
  const { continent, country, is_open_to_public } = queryObj;

  if (continent) {
    data = data.filter((destination) => destination.continent.toLowerCase() === continent.toLowerCase())
  }

  if (country) {
    data = data.filter(destination => destination.country.toLowerCase() === country.toLowerCase())
  }

  if (is_open_to_public) {
    data = data.filter(destination => {
      console.log(destination.is_open_to_public, is_open_to_public);
      console.log(typeof destination.is_open_to_public,typeof is_open_to_public);  // both are of different data types
      console.log(typeof destination.is_open_to_public,typeof JSON.parse(is_open_to_public));  // now change string to boolean

      return destination.is_open_to_public === JSON.parse(is_open_to_public.toLowerCase());
    })
  }

  return data;
}

const server = http.createServer((req, res) => {
  // QUERY Parameters

  // console.log(req.url);  // /api?continent=Africa
  // console.log(req.headers);  
  // {
  //   'user-agent': 'PostmanRuntime/7.51.0',
  //   accept: '*/*',
  //   'cache-control': 'no-cache',
  //   'postman-token': '5162f053-134a-4acd-99ae-cb61f3d53f58',
  //   host: 'localhost:8000',
  //   'accept-encoding': 'gzip, deflate, br',
  //   connection: 'keep-alive'
  // }

  const urlObj = new URL(req.url, `http://${req.headers.host}`);
  // console.log(urlObj);
  // URL {
  //   href: 'http://localhost:8000/api?continent=Africa',
  //   origin: 'http://localhost:8000',
  //   protocol: 'http:',
  //   username: '',
  //   password: '',
  //   host: 'localhost:8000',
  //   hostname: 'localhost',
  //   port: '8000',
  //   pathname: '/api',
  //   search: '?continent=Africa',
  //   searchParams: URLSearchParams { 'continent' => 'Africa' },
  //   hash: ''
  // }

  const queryObj = Object.fromEntries(urlObj.searchParams);
  // console.log(queryObj);  // { continent: 'Africa' }

  if (urlObj.pathname === '/api' && req.method === 'GET') {
    const filteredData = getDatabyQueryParams(destinations, queryObj);
    sendResponse(res, 200, filteredData);
  }
  else if(req.url.startsWith('/api/continent/')){ 
    const continent = req.url.split('/').pop();

    if(!continent) {
      sendResponse(res, 400, {error: "Continent not defined"})
    }
    else {
      const filteredData = getFilteredData('continent', continent);
      sendResponse(res, 200, filteredData);
    }
  }
  else if(req.url.startsWith('/api/country/')){ 
    const country = req.url.split('/').pop();

    if(!country) {
      sendResponse(res, 400, {error: "Country not defined"})
    }
    else {
      const filteredData = getFilteredData('country', country);
      sendResponse(res, 200, filteredData);
    }
  }
  else if (req.url === '/api/destinations' && req.method === 'GET') {
    sendResponse(res, 200, destinations);
  }
  else {
    sendResponse(res, 404, {error: "Resource not found"});
  }
})

server.listen(8000, () => console.log("Server listening at port 8000"));